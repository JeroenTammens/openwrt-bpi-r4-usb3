name: Build OpenWrt BPI-R4 USB3 Mode

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
    - name: Free disk space
      run: |
        echo "=== Before cleanup ==="
        df -h /
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc \
          /usr/local/share/boost /usr/share/swift /opt/hostedtoolcache \
          /usr/local/graalvm /usr/local/.ghcup
        sudo docker image prune --all --force 2>/dev/null || true
        sudo apt-get autoremove -y 2>/dev/null || true
        sudo apt-get clean 2>/dev/null || true
        echo "=== After cleanup ==="
        df -h /

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential clang flex bison g++ gawk \
          gcc-multilib g++-multilib gettext git libncurses-dev libssl-dev \
          python3-distutils python3-setuptools rsync swig unzip zlib1g-dev \
          file wget libelf-dev

    - name: Clone OpenWrt v24.10.0
      run: |
        git clone --branch v24.10.0 --depth 1 https://github.com/openwrt/openwrt.git
        cd openwrt
        echo "Checked out: $(git describe --tags --always)"

    - name: Update and install feeds
      run: |
        cd openwrt
        ./scripts/feeds update -a
        ./scripts/feeds install -a

    - name: Configure (NyaMoe exact packages)
      run: |
        cd openwrt
        cat > .config << 'EOF'
CONFIG_TARGET_mediatek=y
CONFIG_TARGET_mediatek_filogic=y
CONFIG_TARGET_DEVICE_mediatek_filogic_DEVICE_bananapi_bpi-r4=y
CONFIG_PACKAGE_kmod-mtk-t7xx=y
CONFIG_PACKAGE_kmod-phy-aquantia=y
CONFIG_PACKAGE_kmod-sfp=y
CONFIG_PACKAGE_kmod-wwan=y
CONFIG_PACKAGE_kmod-usb-net-rndis=y
CONFIG_PACKAGE_kmod-usb-serial=y
CONFIG_PACKAGE_kmod-usb-serial-option=y
CONFIG_PACKAGE_kmod-usb3=y
CONFIG_PACKAGE_kmod-usb-net-cdc-ncm=y
CONFIG_PACKAGE_kmod-usb-net-cdc-mbim=y
CONFIG_PACKAGE_kmod-usb-wdm=y
CONFIG_PACKAGE_kmod-usb-serial-qualcomm=y
CONFIG_PACKAGE_luci=y
CONFIG_PACKAGE_luci-proto-mbim=y
CONFIG_PACKAGE_luci-proto-modemmanager=y
CONFIG_PACKAGE_luci-proto-ncm=y
CONFIG_PACKAGE_modemmanager=y
CONFIG_PACKAGE_umbim=y
CONFIG_PACKAGE_comgt=y
CONFIG_PACKAGE_pciutils=y
CONFIG_PACKAGE_usbutils=y
CONFIG_PACKAGE_usb-modeswitch=y
CONFIG_PACKAGE_block-mount=y
CONFIG_PACKAGE_nano=y
CONFIG_PACKAGE_curl=y
CONFIG_PACKAGE_picocom=y
EOF
        make defconfig
        echo "=== Config verification ==="
        grep -c "=y" .config
        grep "bpi-r4" .config || echo "WARNING: bpi-r4 not found!"
        grep "CONFIG_TARGET_DEVICE" .config | head -5

    - name: Download all sources
      run: |
        cd openwrt
        make -j$(nproc) download
        echo "=== Downloaded ==="
        ls -lh dl/linux-* 2>/dev/null | head -5

    - name: Prepare kernel source (extract + patch)
      run: |
        cd openwrt
        echo "=== Preparing kernel (extract and apply patches) ==="
        make target/linux/prepare V=s 2>&1 | tee /tmp/prepare.log | tail -30
        RET=${PIPESTATUS[0]}
        if [ $RET -ne 0 ]; then
          echo "=== PREPARE FAILED - last 100 lines ==="
          tail -100 /tmp/prepare.log
          exit $RET
        fi
        echo "=== Kernel source ready ==="

    - name: Modify DTS for USB3 mode (disable pcie2)
      run: |
        cd openwrt
        echo "=== Finding BPI-R4 DTS file ==="
        DTS_FILE=$(find build_dir -name "mt7988a-bananapi-bpi-r4.dts" 2>/dev/null | head -1)

        if [ -z "$DTS_FILE" ]; then
          echo "ERROR: DTS not found! Listing all mediatek dts:"
          find build_dir -name "*.dts" -path "*mediatek*" 2>/dev/null
          exit 1
        fi

        echo "Found: $DTS_FILE"
        echo ""
        echo "=== BEFORE modification (pcie2 section) ==="
        grep -n -B1 -A5 '&pcie2' "$DTS_FILE"

        # NyaMoe's exact modification: disable pcie2 to force USB3 mode
        sed -i '/&pcie2 {/,/};/{s/status = "okay"/status = "disabled"/}' "$DTS_FILE"

        echo ""
        echo "=== AFTER modification (pcie2 section) ==="
        grep -n -B1 -A5 '&pcie2' "$DTS_FILE"

        # Verify
        if grep -A5 '&pcie2' "$DTS_FILE" | grep -q 'disabled'; then
          echo ""
          echo "SUCCESS: pcie2 set to disabled - FM350 will use USB3 mode"
        else
          echo "ERROR: DTS modification failed!"
          exit 1
        fi

    - name: Build full firmware
      run: |
        cd openwrt
        echo "=== Starting full build at $(date) ==="
        echo "WARNING: Do NOT run make clean or download (overwrites DTS change)"
        make -j$(nproc) world 2>&1 | tee /tmp/build.log | tail -5
        RET=${PIPESTATUS[0]}
        if [ $RET -ne 0 ]; then
          echo "=== PARALLEL BUILD FAILED - retrying with V=s ==="
          echo "=== Last 50 lines of failed build ==="
          tail -50 /tmp/build.log
          echo "=== Retrying single-threaded with verbose ==="
          make -j1 V=s world 2>&1 | tee /tmp/build_verbose.log | tail -100
          RET=${PIPESTATUS[0]}
          if [ $RET -ne 0 ]; then
            echo "=== BUILD FAILED ==="
            echo "=== Searching for errors ==="
            grep -i "error:" /tmp/build_verbose.log | tail -20
            exit $RET
          fi
        fi
        echo "=== Build finished at $(date) ==="

    - name: List firmware files
      if: always()
      run: |
        echo "=== All output files ==="
        ls -lh openwrt/bin/targets/mediatek/filogic/ 2>/dev/null || echo "No output dir"
        echo ""
        echo "=== BPI-R4 firmware files ==="
        ls -lh openwrt/bin/targets/mediatek/filogic/*bpi-r4* 2>/dev/null || echo "No BPI-R4 files"
        echo ""
        echo "=== Disk usage ==="
        df -h /

    - name: Upload firmware
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-bpi-r4-usb3-firmware
        path: |
          openwrt/bin/targets/mediatek/filogic/*bpi-r4*
        retention-days: 30
        if-no-files-found: error
